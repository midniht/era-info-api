#!/bin/bash

humanize_size() {
  while read file_bytes dummy; do
    [ $file_bytes -lt 1024 ] && echo ${file_bytes} B && break
    file_kilobytes=$(((file_bytes + 512) / 1024))
    [ $file_kilobytes -lt 1024 ] && echo ${file_kilobytes} KB && break
    file_megabytes=$(((file_kilobytes + 512) / 1024))
    [ $file_megabytes -lt 1024 ] && echo ${file_megabytes} MB && break
    file_gigabytes=$(((file_megabytes + 512) / 1024))
    [ $file_gigabytes -lt 1024 ] && echo ${file_gigabytes} GB && break
    file_terabytes=$(((file_gigabytes + 512) / 1024))
    echo ${file_terabytes} TB
  done
}

print_usage() {
  echo "å‚æ•°ç”¨æ³•:

    --api-token
            æŒ‡å®š IP

    --tg-bot-token
            æŒ‡å®šç«¯å£

    --tg-channel-id
            æŒ‡å®šç«¯å£

    -h, --help
            æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"
}

init() {
  ARGS=$(getopt --options h --long api-token:,tg-bot-token:,tg-channel-id:,help -n 'ä¸­æ–‡eraç‰ˆæœ¬æ›´æ–°é›†æˆè„šæœ¬' -- "$@")
  if [ $? != 0 ]; then
    echo "error: ä½¿ç”¨ getopt è§£æå‚æ•°æ—¶å‘ç”Ÿé”™è¯¯"
    exit 1
  fi

  echo $ARGS
  eval set -- "${ARGS}"
  while true; do
    case "$1" in
    --api-token)
      API_TOKEN="$2"
      shift 2
      ;;
    --tg-bot-token)
      TELEGRAM_BOT_TOKEN="$2"
      shift 2
      ;;
    --tg-channel-id)
      TELEGRAM_CHANNEL_ID="$2"
      shift 2
      ;;
    -h | --help)
      print_usage
      exit
      ;;
    --)
      shift
      break
      ;;
    *)
      echo "error: å†…éƒ¨å¤„ç†å‡ºé”™"
      exit 1
      ;;
    esac
  done

  if [ ! $API_TOKEN ]; then
    if [ $# != 0 ]; then
      API_TOKEN="$1"
    else
      token_file="$(dirname $0)/ERA_API_TOKEN"
      if [ -f "${token_file}" ]; then
        API_TOKEN=$(sed -n '1p;1q' ${token_file})
      else
        echo "error: æ²¡æœ‰æŒ‡å®š API token"
        exit 1
      fi
    fi
  fi

  API_URL="api.erag.eu.org"
}

gen_version_json() {
  GAMEBASE_FILE=$(find . -iwholename "./csv/gamebase.csv")
  GAME_SLUG="$(basename $(git rev-parse --show-toplevel))"
  GAME_NAME=$(cat "./README.md" | grep -m 1 "^# " | sed "s/^# //" | sed "s/ //g" | sed "s/\r*//g")
  GAME_VERSION=$(cat ${GAMEBASE_FILE} | grep -m 1 "^ãƒãƒ¼ã‚¸ãƒ§ãƒ³å" | sed "s/^ãƒãƒ¼ã‚¸ãƒ§ãƒ³å\s*,\s*//" | sed "s/ //g" | sed "s/\r*//g")
  GAME_TITLE=$(cat ${GAMEBASE_FILE} | grep -m 1 "^ã‚¿ã‚¤ãƒˆãƒ«" | sed "s/^ã‚¿ã‚¤ãƒˆãƒ«\s*,\s*//" | sed "s/^ *//g" | sed "s/\r*//g" | sed 's/\"/\\\"/g')
  GAME_AUTHOR=$(cat ${GAMEBASE_FILE} | grep -m 1 "^ä½œè€…" | sed "s/^ä½œè€…\s*,\s*//" | sed "s/^ *//g" | sed "s/\r*//g" | sed 's/\"/\\\"/g')
  GAME_INFO=$(cat ${GAMEBASE_FILE} | grep -m 1 "^è¿½åŠ æƒ…å ±" | sed "s/^è¿½åŠ æƒ…å ±\s*,\s*//" | sed "s/^ *//g" | sed "s/\r*//g" | sed 's/\"/\\\"/g')

  if [ ! $GAME_TITLE ]; then
    GAME_TITLE="$GAME_NAME"
  fi

  temp=($(git ls-remote --get-url origin | tr '/' ' '))
  GIT_COMMIT_URL="https://gitgud.io/era-games-zh/${temp[@]:(-2):1}/${GAME_SLUG}/-/commit/$(git rev-parse HEAD)"

  GAME_SIZE="$(du -b ${GAME_NAME}.zip | humanize_size)"

  if [ -f "${GAME_NAME}.zip" ]; then
    GAME_HASH=$(sha1sum ${GAME_NAME}.zip | awk '{print $1}')
  else
    GAME_HASH="error: file ${GAME_NAME}.zip not found"
  fi
  GIT_COMMIT_MESSAGE=$(git log -1 --pretty='%B' | sed 's/\r//g' | sed ':label;N;s/\n/\\n/;b label' | sed 's/^[ \s]\{1,\}//g;s/[ \s]\{1,\}$//g' | sed 's/\"/\\\"/g' | sed 's/\t/ /g')

  version_json="{
  \"slug\": \"${GAME_SLUG}\",
  \"name\": \"${GAME_NAME}\",
  \"version\": \"${GAME_VERSION}\",
  \"update_at\": \"$(date '+%Y-%m-%d %H:%M:%S')\",
  \"title\": \"${GAME_TITLE}\",
  \"author\": \"${GAME_AUTHOR}\",
  \"description\": \"${GAME_INFO}\",
  \"message\": \"${GIT_COMMIT_URL}\n${GIT_COMMIT_MESSAGE}\",
  \"size\": \"${GAME_SIZE}\",
  \"hash\": \"${GAME_HASH}\"
}"

  echo "Working Directory: \"$(pwd)\""
  echo "[DEBUG] JSON Body for API: ${version_json}"
}

update_api() {
  resp_code=$(
    curl -l -s -w "%{http_code}" -o /tmp/era-games-update-version-result.log -X POST "https://${API_URL}/${GAME_SLUG}" \
    -H "Content-Type: application/json;charset=UTF-8" \
    -H "X-Custom-PSK: ${API_TOKEN}" \
    -d "$version_json"
  )

  if [ $resp_code == "200" ]; then
    echo -e "$(cat /tmp/era-games-update-version-result.log)\nç‰ˆæœ¬ä¿¡æ¯æ•°æ®åº“ https://${API_URL}/${GAME_SLUG}/version æ›´æ–°æˆåŠŸ"
  else
    echo -e "æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯å¤±è´¥ è¿”å›çš„å“åº”ä¸º ${resp_code}\n$(cat /tmp/era-games-update-version-result.log)"
    exit 1
  fi
}

push_to_telegram() {
  download_url="https://${API_URL}/${GAME_SLUG}/download"
  message_text="ä¸­æ–‡ era æ¸¸æˆåº“ - <a href=\\\"https://gitgud.io/era-games-zh/${temp[@]:(-2):1}/${GAME_SLUG}\\\">Git ä»“åº“</a>

â–<b>${GAME_TITLE}</b> <i>${GAME_VERSION}</i>

æ›´æ–°äº $(date '+%Y-%m-%d %H:%M:%S') CST

ğŸ· #ç†Ÿè‚‰
ğŸ“¥ <a href=\\\"${download_url}\\\">ç‚¹å‡»ç›´æ¥ä¸‹è½½</a>
<code>${GAME_NAME}.zip</code> <i>${GAME_SIZE}</i>

â–<a href=\\\"${GIT_COMMIT_URL}\\\">ä¸Šæ¬¡æ”¹åŠ¨è¯¦æƒ…</a>

${GIT_COMMIT_MESSAGE}"
  echo "[DEBUG] Message content for Telegram: ${message_text}"
  zip_size=$(du -b ${GAME_NAME}.zip | awk '{print $1}')
  if ((zip_size < 20 * 1024 * 1024)); then
    telegram_json="{
  \"chat_id\": \"${TELEGRAM_CHANNEL_ID}\",
  \"document\": \"${download_url}\",
  \"caption\": \"${message_text}\",
  \"parse_mode\": \"HTML\",
  \"disable_web_page_preview\": true
}"
    resp_code=$(
      curl -l -s -w "%{http_code}" -o /tmp/era-games-push-telegram-result.log \
      -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument" \
      -H "Content-Type: application/json;charset=UTF-8" \
      -d "$telegram_json"
    )
  else
    telegram_json="{
  \"chat_id\": \"${TELEGRAM_CHANNEL_ID}\",
  \"text\": \"${message_text}\",
  \"parse_mode\": \"HTML\",
  \"disable_web_page_preview\": true
}"
    resp_code=$(
      curl -l -s -w "%{http_code}" -o /tmp/era-games-push-telegram-result.log \
      -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
      -H "Content-Type: application/json;charset=UTF-8" \
      -d "$telegram_json"
    )
  fi

  if [ $resp_code == "200" ]; then
    echo -e "$(cat /tmp/era-games-push-telegram-result.log)\næ¨é€åˆ° Telegram æˆåŠŸ"
  else
    echo -e "æ¨é€åˆ° Telegram å¤±è´¥ è¿”å›çš„å“åº”ä¸º ${resp_code}\n$(cat /tmp/era-games-push-telegram-result.log)"
    exit 0
  fi
}

main() {
  init $@
  gen_version_json
  update_api
  if [ $TELEGRAM_BOT_TOKEN ] && [ $TELEGRAM_CHANNEL_ID ]; then
    push_to_telegram
  fi
}

main $@
